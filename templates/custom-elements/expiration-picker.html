<template id="expiration-picker-template">
  <style nonce="{{ .CspNonce }}">
    @import "/third-party/bulma@0.9.3/bulma.min.css";
    @import "/third-party/js-datepicker@5.18.0/datepicker.min.css";
  </style>
  <div class="control">
    <input
      id="expiration"
      class="input is-normal"
      type="text"
    />
  </div>
</div>
</template>

<script type="module" nonce="{{ .CspNonce }}">
  // Note: I don't know of a cleaner way of doing this. datepicker doesn't seem
  // to export values like a proper JS module, so we import the whole JS file,
  // which populates window.datepicker.
  import "/third-party/js-datepicker@5.18.0/js-datepicker.js";

  (function () {
    const template = document.querySelector("#expiration-picker-template");

    customElements.define(
      "expiration-picker",
      class extends HTMLElement {
        connectedCallback() {
          this.attachShadow({ mode: "open" }).appendChild(
            template.content.cloneNode(true)
          );
          this.elements = {
            expirationInput: this.shadowRoot.getElementById('expiration'),
          }

          const picker = window.datepicker(this.elements.expirationInput, {
            minDate: this._tomorrow(),
            dateSelected: this._defaultExpirationDate(),
            formatter: (input, date) => {
              input.value = date.toLocaleDateString();
            },
            respectDisabledReadOnly: true,
          });
        }

        static get observedAttributes() {
          return ["expiration", "disabled"];
        }

        attributeChangedCallback(name, oldValue, newValue) {
          if (!this.elements) {
            return;
          }
          if (name === "disabled") {
            if (newValue === "true") {
              this.elements.expirationInput.setAttribute("disabled", true);
            } else {
              this.elements.expirationInput.removeAttribute("disabled");
            }
          } else if (name === "expiration") {
            this.elements.expirationInput.value = newValue;
          }
        }

        get value() {
          return this.getAttribute("expiration");
        }
/*
        get expiration() {
          return this.getAttribute("expiration");
        }

        set expiration(newValue) {
          this.setAttribute("expiration", newValue);
        }*/

        _tomorrow() {
          return this._dateInNDays(1);
        }

        _dateInNDays(n) {
          let d = new Date();
          d.setDate(d.getDate() + n);
          return d;
        }

        _defaultExpirationDate() {
          const expirationRaw = this.elements.expirationInput.getAttribute("data-expiration-raw");

          if (!expirationRaw) {
            return this._dateInNDays(30);
          }
          return new Date(expirationRaw);
        }
      }
    );
  })();
</script>
</template>
