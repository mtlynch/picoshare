#!/usr/bin/env bash
#
# Run the full PicoShare performance test matrix with Firecracker
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Test matrix configuration
FILE_SIZES=("100M" "500M" "1G" "2G" "5G")
MEMORY_LIMITS=("2048" "1024" "512" "256")

RESULTS_BASE_DIR="$SCRIPT_DIR/results"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

log "==================================================="
log "Pre-test preparation"
log "==================================================="
log "Branch: $(git branch --show-current)"
log "Commit: $(git rev-parse --short HEAD)"
log ""

# Build binary once before all tests using dev-scripts/build-backend
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

log "Building PicoShare binary..."
cd "$PROJECT_ROOT"
export PS_VERSION="${PS_VERSION:-dev}"
# Use Go 1.24 from /usr/local/go (required for time.DateOnly and ncruces2)
export PATH="/usr/local/go/bin:$PATH"
"$PROJECT_ROOT/dev-scripts/build-backend"

if [[ ! -f "$PROJECT_ROOT/bin/picoshare" ]]; then
    log "ERROR: Build failed - picoshare binary not found at bin/picoshare"
    exit 1
fi

log "✓ Build complete: $(ls -lh "$PROJECT_ROOT/bin/picoshare" | awk '{print $5}')"

# Update VM image with new binary
log "Updating VM image with new binary..."
ROOTFS="$SCRIPT_DIR/firecracker-images/rootfs-working.ext4"

if [[ ! -f "$ROOTFS" ]]; then
    log "ERROR: VM rootfs not found at $ROOTFS"
    exit 1
fi

log "Mounting $ROOTFS..."
sudo mount -o loop "$ROOTFS" /mnt

log "Copying binary to /usr/local/bin/picoshare..."
sudo cp "$PROJECT_ROOT/bin/picoshare" /mnt/usr/local/bin/picoshare

log "Cleaning /tmp to free disk space..."
sudo rm -rf /mnt/tmp/* 2>/dev/null || true
sudo du -sh /mnt/tmp 2>/dev/null | awk '{print "  /tmp size: " $1}'
sudo df -h /mnt | tail -1 | awk '{print "  Disk free: " $4 " (" $5 " used)"}'

log "Unmounting..."
sudo umount /mnt

log "✓ VM image updated and cleaned"
log ""

cd "$SCRIPT_DIR"

# Create results directory with branch name
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BRANCH_NAME=$(git branch --show-current | sed 's/perf\///')
RUN_DIR="$RESULTS_BASE_DIR/matrix-${BRANCH_NAME}-${TIMESTAMP}"
mkdir -p "$RUN_DIR"

SUMMARY_FILE="$RUN_DIR/summary.txt"
CSV_FILE="$RUN_DIR/matrix-results.csv"

# Initialize CSV
echo "ram_mb,file_size,boot_time_seconds,duration_seconds,throughput_mbps,http_status,exit_reason,success" > "$CSV_FILE"

log "==================================================="
log "PicoShare Firecracker Performance Test Matrix"
log "==================================================="
log "Memory configs: ${MEMORY_LIMITS[*]}"
log "File sizes: ${FILE_SIZES[*]}"
log "Total tests: $((${#MEMORY_LIMITS[@]} * ${#FILE_SIZES[@]}))"
log "Results directory: $RUN_DIR"
log ""

# Statistics
total_tests=$((${#MEMORY_LIMITS[@]} * ${#FILE_SIZES[@]}))
current_test=0
passed_tests=0
failed_tests=0
start_time=$(date +%s)

# Clean up any stale routes before starting
log "Cleaning up stale network routes..."
"$SCRIPT_DIR/cleanup-network"

# Run tests
for memory in "${MEMORY_LIMITS[@]}"; do
    log "=========================================="
    log "Testing with ${memory}MB RAM"
    log "=========================================="
    log ""

    for size in "${FILE_SIZES[@]}"; do
        current_test=$((current_test + 1))
        log "[$current_test/$total_tests] Running: ${memory}MB RAM, ${size} file"

        # Clean up route before each test
        "$SCRIPT_DIR/cleanup-network"

        # Run single test
        test_start=$(date +%s)

        # Run test and capture output (skip build since we already did it)
        if SKIP_BUILD=1 "$SCRIPT_DIR/run-test" "$memory" "$size" 2>&1 | tee "$RUN_DIR/test-${memory}MB-${size}.log"; then
            result_file=$(grep '^/.*\.json$' "$RUN_DIR/test-${memory}MB-${size}.log" | tail -1)
            passed_tests=$((passed_tests + 1))
            test_status="PASS"
        else
            result_file=$(grep '^/.*\.json$' "$RUN_DIR/test-${memory}MB-${size}.log" | tail -1)
            failed_tests=$((failed_tests + 1))
            test_status="FAIL"
        fi

        test_end=$(date +%s)
        test_duration=$((test_end - test_start))

        # Extract result data and append to CSV
        if [[ -f "$result_file" ]] && command -v jq >/dev/null 2>&1; then
            jq -r '[.ram_mb, .file_size, .boot_time_seconds, .duration_seconds, .throughput_mbps, .http_status, .exit_reason, .success] | @csv' "$result_file" >> "$CSV_FILE"
        fi

        log "[$current_test/$total_tests] $test_status (took ${test_duration}s)"
        log ""

        # Brief pause between tests
        sleep 2
    done
done

end_time=$(date +%s)
total_duration=$((end_time - start_time))

# Generate summary
{
    echo "==================================================="
    echo "PicoShare Firecracker Performance Test Matrix Summary"
    echo "==================================================="
    echo ""
    echo "Timestamp: $(date -Iseconds)"
    echo "Total Duration: ${total_duration}s ($((total_duration / 60))m)"
    echo ""
    echo "Tests Run: $current_test / $total_tests"
    echo "Passed: $passed_tests"
    echo "Failed: $failed_tests"
    echo ""

    if [[ -f "$CSV_FILE" ]] && command -v column >/dev/null 2>&1; then
        echo "Results:"
        echo ""
        column -t -s',' "$CSV_FILE"
    fi
} | tee "$SUMMARY_FILE"

log ""
log "==================================================="
log "Test matrix complete!"
log "  Passed: $passed_tests"
log "  Failed: $failed_tests"
log "  Total:  $current_test"
log ""
log "Results saved to: $RUN_DIR"
log "==================================================="

exit $( [[ $failed_tests -eq 0 ]] && echo 0 || echo 1 )
